# ğŸ”¬ é€Ÿåº¦å…ˆéªŒ vs ç‚¹åŒ¹é…å…ˆéªŒ - æ·±åº¦å¯¹æ¯”

## ğŸ¯ é—®é¢˜æ ¹æºåˆ†æ

### **ä¸ºä»€ä¹ˆé€Ÿåº¦å…ˆéªŒæ²¡æœ‰æ¶¨ç‚¹ï¼Ÿ**

```python
# æ ¸å¿ƒé—®é¢˜ï¼šä¿¡æ¯å®Œå…¨æ¥è‡ªåŒä¸€æ¥æº

# ä½å§¿å˜æ¢
prev2curr_matrix = curr_g2e @ prev_e2g
# æ¥æºï¼šGPS/IMUçš„ä½å§¿æµ‹é‡

# é€Ÿåº¦è®¡ç®—  
velocity = (pos_next - pos_curr) / dt
# æ¥æºï¼šGPS/IMUçš„ä½å§¿æµ‹é‡ï¼ˆåŒä¸€ä¸ªï¼ï¼‰

# ç»“è®ºï¼šé€Ÿåº¦ = ä½å§¿çš„ä¸€é˜¶å¯¼æ•°
#      ä½å§¿çŸ©é˜µå·²ç»éšå¼åŒ…å«äº†é€Ÿåº¦ä¿¡æ¯
#      æ˜¾å¼æä¾›é€Ÿåº¦æ²¡æœ‰å¸¦æ¥æ–°ä¿¡æ¯
```

---

## ğŸ“Š ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

### **æ–¹æ¡ˆ1: é€Ÿåº¦å…ˆéªŒ**ï¼ˆå·²å®ç°ï¼Œæ— æ•ˆæœï¼‰

```python
# ä¿¡æ¯æµ
GPS/IMUä½å§¿ â†’ è®¡ç®—é€Ÿåº¦ â†’ é€Ÿåº¦ç¼–ç  â†’ èåˆåˆ°query
     â†“
  ä½å§¿ç¼–ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ èåˆåˆ°query

# é—®é¢˜ï¼šä¸¤æ¡è·¯å¾„çš„ä¿¡æ¯æ¥æºç›¸åŒï¼
```

**ç»“æœ**: âŒ æ— æ¶¨ç‚¹ï¼ˆä¿¡æ¯å†—ä½™ï¼‰

---

### **æ–¹æ¡ˆ2: ç‚¹åŒ¹é…å…ˆéªŒ**ï¼ˆæ¨èï¼‰

```python
# ä¿¡æ¯æµ
GPS/IMUä½å§¿ â†’ å‡ ä½•å˜æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¼ æ’­çš„ç‚¹
                              â†“
GTæ ‡æ³¨ â†’ ç‚¹åŒ¹é… â†’ åŒ¹é…çš„GTç‚¹ â†’ èåˆ â†’ æœ€ç»ˆå‚è€ƒç‚¹
  â†‘
æ–°çš„ä¿¡æ¯æ¥æºï¼

# å…³é”®ï¼šGTæ ‡æ³¨æ˜¯ç‹¬ç«‹çš„ä¿¡æ¯æº
```

**é¢„æœŸ**: âœ… +1.5-3.0 APï¼ˆæä¾›æ–°ä¿¡æ¯ï¼‰

---

## ğŸ” è¯¦ç»†å¯¹æ¯”

### **1. ä¿¡æ¯æ¥æº**

| æ–¹æ¡ˆ | ä¿¡æ¯æ¥æº | ç‹¬ç«‹æ€§ |
|------|---------|--------|
| é€Ÿåº¦å…ˆéªŒ | GPS/IMUä½å§¿ | âŒ ä¸ä½å§¿å˜æ¢ç›¸åŒ |
| ç‚¹åŒ¹é…å…ˆéªŒ | GTæ ‡æ³¨ | âœ… ç‹¬ç«‹çš„ä¿¡æ¯æº |

---

### **2. æä¾›çš„ä¿¡æ¯ç±»å‹**

#### é€Ÿåº¦å…ˆéªŒ
```python
velocity = [vx, vy, |v|, dt]

å‘Šè¯‰æ¨¡å‹ï¼š
- "è‡ªè½¦ä»¥10m/så‘å‰è¿åŠ¨"
- "æ—¶é—´é—´éš”æ˜¯0.5ç§’"

æ¨¡å‹æ¨æ–­ï¼š
- "åœ°å›¾ç‚¹åº”è¯¥å‘åç§»åŠ¨5ç±³"

é—®é¢˜ï¼šè¿™ä¸ªæ¨æ–­ä½å§¿çŸ©é˜µå·²ç»åšäº†ï¼
```

#### ç‚¹åŒ¹é…å…ˆéªŒ
```python
matching = {
    pred_point_5 â†’ gt_point_12,
    pred_point_8 â†’ gt_point_3,
    ...
}

å‘Šè¯‰æ¨¡å‹ï¼š
- "ä¸Šä¸€å¸§çš„ç¬¬5ä¸ªç‚¹å¯¹åº”å½“å‰å¸§çš„ç¬¬12ä¸ªGTç‚¹"
- "å®ƒçš„å‡†ç¡®ä½ç½®æ˜¯ (15.2m, 2.1m)"

æ¨¡å‹å­¦ä¹ ï¼š
- "è¿™æ¡è½¦é“çº¿åœ¨ä¸¤å¸§ä¹‹é—´çš„å¯¹åº”å…³ç³»"
- "å¦‚ä½•çº æ­£å‡ ä½•å˜æ¢çš„è¯¯å·®"

ä¼˜åŠ¿ï¼šè¿™æ˜¯ä½å§¿å˜æ¢æ— æ³•æä¾›çš„ï¼
```

---

### **3. å¤„ç†çš„é—®é¢˜**

| åœºæ™¯ | é€Ÿåº¦å…ˆéªŒ | ç‚¹åŒ¹é…å…ˆéªŒ |
|------|---------|-----------|
| **åŒ€é€Ÿç›´è¡Œ** | âŒ å†—ä½™ | âœ… çº æ­£è¯¯å·® |
| **è½¬å¼¯** | âŒ å†—ä½™ | âœ… è¯­ä¹‰å¯¹åº” |
| **é®æŒ¡æ¢å¤** | âŒ æ— å¸®åŠ© | âœ… ç›´æ¥åŒ¹é… |
| **æ£€æµ‹è¯¯å·®** | âŒ æ— å¸®åŠ© | âœ… çº æ­£ä½ç½® |
| **åœ°å›¾å˜åŒ–** | âŒ æ— å¸®åŠ© | âœ… é€‚åº”å˜åŒ– |

---

## ğŸ’¡ ä¸ºä»€ä¹ˆç‚¹åŒ¹é…ä¼šæœ‰æ•ˆï¼Ÿ

### **æ ¸å¿ƒæ´å¯Ÿ**

```
å‡ ä½•å˜æ¢ï¼ˆä½å§¿ï¼‰ï¼šå‘Šè¯‰ä½ "ç‰©ç†ä¸Šåº”è¯¥åœ¨å“ª"
ç‚¹åŒ¹é…ï¼ˆGTï¼‰ï¼šå‘Šè¯‰ä½ "å®é™…ä¸Šåœ¨å“ª"

è¿™ä¸¤è€…å¯èƒ½ä¸åŒï¼
```

### **å…·ä½“ä¾‹å­**

#### ä¾‹å­1: æ£€æµ‹è¯¯å·®ç´¯ç§¯

```
t=0: æ£€æµ‹è½¦é“çº¿ï¼Œè¯¯å·® +0.1m
  â†“ å‡ ä½•å˜æ¢
t=1: ä¼ æ’­ä½ç½®ï¼Œè¯¯å·® +0.1mï¼ˆç´¯ç§¯ï¼‰
  â†“ å‡ ä½•å˜æ¢  
t=2: ä¼ æ’­ä½ç½®ï¼Œè¯¯å·® +0.1mï¼ˆç´¯ç§¯ï¼‰
  â†“
è¯¯å·®è¶Šæ¥è¶Šå¤§ï¼

ğŸ”‘ ç‚¹åŒ¹é…çš„ä½œç”¨ï¼š
t=1: åŒ¹é…åˆ°GTï¼Œçº æ­£è¯¯å·® â†’ 0m
t=2: ä»å‡†ç¡®ä½ç½®å¼€å§‹ä¼ æ’­
```

#### ä¾‹å­2: é®æŒ¡åœºæ™¯

```
t=0: è½¦é“çº¿è¢«é®æŒ¡ï¼Œæœªæ£€æµ‹åˆ°
t=1: è½¦é“çº¿å¯è§ï¼Œæ£€æµ‹åˆ°

å‡ ä½•å˜æ¢ï¼šæ— æ³•å¤„ç†ï¼ˆt=0æ²¡æœ‰ç‚¹ï¼‰
ç‚¹åŒ¹é…ï¼šç›´æ¥åŒ¹é…t=1çš„GT âœ…
```

#### ä¾‹å­3: å¤šæ¡ç›¸ä¼¼è½¦é“çº¿

```
åœºæ™¯ï¼šä¸¤æ¡å¹³è¡Œè½¦é“çº¿

å‡ ä½•å˜æ¢ï¼š
- è½¦é“çº¿Aä¼ æ’­åˆ°ä½ç½®X
- è½¦é“çº¿Bä¼ æ’­åˆ°ä½ç½®Y
- ä½†Xå’ŒYå¾ˆæ¥è¿‘ï¼Œå®¹æ˜“æ··æ·†

ç‚¹åŒ¹é…ï¼š
- è½¦é“çº¿AåŒ¹é…åˆ°GT_Aï¼ˆè¯­ä¹‰å¯¹åº”ï¼‰
- è½¦é“çº¿BåŒ¹é…åˆ°GT_Bï¼ˆè¯­ä¹‰å¯¹åº”ï¼‰
- æ˜ç¡®åŒºåˆ† âœ…
```

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### **é˜¶æ®µ1: åŸºç¡€å®ç°**ï¼ˆ1å‘¨ï¼‰

```python
# æœ€ç®€å•çš„ç‰ˆæœ¬ï¼šæœ€è¿‘é‚»åŒ¹é… + åŒ¹é…loss

def match_to_gt_simple(pred_points, gt_points):
    # è®¡ç®—è·ç¦»
    distances = cdist(pred_points, gt_points)
    # æœ€è¿‘é‚»
    matched_idx = distances.argmin(axis=1)
    return gt_points[matched_idx]

# åœ¨propagateä¸­ä½¿ç”¨
matched_gt = match_to_gt_simple(curr_ref_pts, gt_lines)
matching_loss = L1(curr_ref_pts, matched_gt)
trans_loss += 0.5 * matching_loss
```

**é¢„æœŸ**: +1.0-2.0 AP

---

### **é˜¶æ®µ2: ç½®ä¿¡åº¦åŠ æƒ**ï¼ˆ2å‘¨ï¼‰

```python
# åŠ å…¥åŒ¹é…ç½®ä¿¡åº¦

matched_gt, confidence = match_to_gt_with_confidence(
    curr_ref_pts, gt_lines
)

# æ ¹æ®ç½®ä¿¡åº¦èåˆ
final_ref_pts = confidence * matched_gt + (1-confidence) * curr_ref_pts

# è‡ªé€‚åº”lossæƒé‡
matching_loss = confidence * L1(curr_ref_pts, matched_gt)
```

**é¢„æœŸ**: +2.0-3.0 AP

---

### **é˜¶æ®µ3: å­¦ä¹ å¼åŒ¹é…**ï¼ˆ3-4å‘¨ï¼‰

```python
# ç«¯åˆ°ç«¯å­¦ä¹ åŒ¹é…

class LearnableMatcher(nn.Module):
    # å­¦ä¹ å¦‚ä½•åŒ¹é…
    # è€ƒè™‘ç‚¹çš„å½¢çŠ¶ã€ä½ç½®ã€ç±»åˆ«ç­‰

matching_matrix = learnable_matcher(pred_points, gt_points)
matched_gt = soft_matching(gt_points, matching_matrix)
```

**é¢„æœŸ**: +3.0-4.0 AP

---

## ğŸ“Š å®éªŒè®¾è®¡

### **æ¶ˆèå®éªŒ**

```bash
# å®éªŒ1: Baseline
streaming=True, velocity=False, matching=False
é¢„æœŸ: 34.1 AP

# å®éªŒ2: + é€Ÿåº¦å…ˆéªŒï¼ˆå·²éªŒè¯æ— æ•ˆï¼‰
streaming=True, velocity=True, matching=False
ç»“æœ: 34.1 AP (æ— æå‡ âŒ)

# å®éªŒ3: + ç‚¹åŒ¹é…å…ˆéªŒï¼ˆæ¨èï¼‰
streaming=True, velocity=False, matching=True
é¢„æœŸ: 35.6-37.1 AP (+1.5-3.0) âœ…

# å®éªŒ4: é€Ÿåº¦ + åŒ¹é…ï¼ˆå¯é€‰ï¼‰
streaming=True, velocity=True, matching=True
é¢„æœŸ: 35.8-37.5 AP (+1.7-3.4) âœ…
```

---

## ğŸ”§ å¿«é€Ÿå®ç°ä»£ç æ¡†æ¶

### **ä¿®æ”¹1: MapDetectorHead.__init__**

```python
def __init__(self, streaming_cfg=dict(), ...):
    # ...
    if self.streaming_query:
        self.use_point_matching_prior = streaming_cfg.get('use_point_matching_prior', False)
        self.matching_loss_weight = streaming_cfg.get('matching_loss_weight', 0.5)
        
        if self.use_point_matching_prior:
            # åˆå§‹åŒ–åŒ¹é…æ¨¡å—
            self.point_matcher = PointMatcher(
                num_points=self.num_points,
                threshold=2.0  # åŒ¹é…è·ç¦»é˜ˆå€¼ï¼ˆç±³ï¼‰
            )
```

---

### **ä¿®æ”¹2: MapDetectorHead.propagate**

```python
def propagate(self, query_embedding, img_metas, gts=None, return_loss=True):
    # ... å‰é¢ä»£ç ä¸å˜ ...
    
    for i in range(bs):
        if not is_first_frame:
            # å‡ ä½•å˜æ¢ï¼ˆåŸæœ‰ï¼‰
            curr_ref_pts = transform(prev_ref_pts, prev2curr_matrix)
            
            # ğŸ†• ç‚¹åŒ¹é…å…ˆéªŒ
            if return_loss and gts is not None and self.use_point_matching_prior:
                gt_lines = gts['lines'][i]
                
                # åŒ¹é…
                matched_gt, confidence = self.point_matcher(
                    curr_ref_pts, gt_lines
                )
                
                # èåˆ
                curr_ref_pts = confidence * matched_gt + (1-confidence) * curr_ref_pts
                
                # åŒ¹é…loss
                matching_loss += self.loss_reg(
                    curr_ref_pts.view(-1, 2*self.num_points),
                    matched_gt.view(-1, 2*self.num_points),
                    weights
                )
    
    if return_loss:
        trans_loss += self.matching_loss_weight * matching_loss
```

---

### **ä¿®æ”¹3: é…ç½®æ–‡ä»¶**

```python
# plugin/configs/nusc_newsplit_480_60x30_24e_matching.py

model = dict(
    head_cfg=dict(
        streaming_cfg=dict(
            streaming=True,
            use_velocity_prior=False,        # ä¸ç”¨é€Ÿåº¦
            use_point_matching_prior=True,   # ğŸ†• ç”¨ç‚¹åŒ¹é…
            matching_loss_weight=0.5,        # åŒ¹é…lossæƒé‡
        ),
    ),
)
```

---

## ğŸ¯ æ€»ç»“

### **é€Ÿåº¦å…ˆéªŒå¤±è´¥çš„æ•™è®­**

âœ… **æ­£ç¡®çš„åˆ†æ**: ä¿¡æ¯å†—ä½™æ˜¯æ ¹æœ¬åŸå›   
âœ… **å®è´µçš„ç»éªŒ**: è¦æä¾›çœŸæ­£çš„æ–°ä¿¡æ¯  
âœ… **æ–°çš„æ–¹å‘**: ç‚¹åŒ¹é…å…ˆéªŒæ›´æœ‰ä»·å€¼

### **ç‚¹åŒ¹é…å…ˆéªŒçš„ä¼˜åŠ¿**

1. **ç‹¬ç«‹ä¿¡æ¯æº**: æ¥è‡ªGTæ ‡æ³¨ï¼Œä¸æ˜¯ä½å§¿æ¨å¯¼
2. **è¯­ä¹‰å¯¹åº”**: å»ºç«‹ç‚¹ä¹‹é—´çš„å¯¹åº”å…³ç³»
3. **çº æ­£è¯¯å·®**: ä¿®æ­£å‡ ä½•å˜æ¢çš„ç´¯ç§¯è¯¯å·®
4. **å¤„ç†å›°éš¾åœºæ™¯**: é®æŒ¡ã€æ··æ·†ã€åœ°å›¾å˜åŒ–

### **è¡ŒåŠ¨å»ºè®®**

1. âœ… **æ”¾å¼ƒé€Ÿåº¦å…ˆéªŒ**ï¼ˆä¿¡æ¯å†—ä½™ï¼‰
2. âœ… **å®æ–½ç‚¹åŒ¹é…å…ˆéªŒ**ï¼ˆçœŸæ­£æœ‰æ•ˆï¼‰
3. âœ… **é¢„æœŸæ”¶ç›Š**: +1.5-3.0 AP

---

**è¿™æ˜¯ä¸€ä¸ªæ›´æœ‰å‰æ™¯çš„ç ”ç©¶æ–¹å‘ï¼** ğŸ‰

